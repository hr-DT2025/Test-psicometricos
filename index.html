<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evaluación de Competencias | Disruptive Talent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dt-primary': '#0F3460',
            'dt-accent': '#3B82F6',
            'dt-secondary': '#E5E7EB',
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
        },
      },
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .nav-btn { transition: all 0.3s ease; }
    .test-section { display: none; }
    .test-section.active { display: block; }
  </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4 md:p-8">
  <main class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-10 border-t-8 border-dt-accent">
    <header class="text-center mb-10">
      <div class="flex items-center justify-center mb-3">
        <img src="icon_dark.png" alt="Disruptive Talent Logo" class="h-8 mr-3" />
        <h1 class="text-3xl font-extrabold text-dt-primary">Talent Assessment</h1>
      </div>
      <p class="text-gray-500 text-lg">Evaluación de Competencias para la Transformación Digital</p>
      <div class="h-1 w-20 bg-dt-accent mx-auto mt-4 rounded-full"></div>
    </header>

    <form id="psychometric-test-form" class="space-y-10">
      <!-- 1. Datos personales -->
      <section id="section-1" class="test-section active">
        <h2 class="text-xl font-semibold mb-6 text-dt-primary border-b border-dt-secondary pb-2">1/4. Información Personal</h2>
        <p class="text-sm text-gray-600 mb-6 bg-blue-50 p-3 rounded-lg border-l-4 border-dt-accent">Proporciona tus datos para el reporte de feedback.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-dt-primary">Nombre completo</label>
            <input name="nombre" required class="mt-1 w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-dt-accent" />
          </div>
          <div>
            <label class="block text-sm font-medium text-dt-primary">Correo</label>
            <input type="email" name="correo" required class="mt-1 w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-dt-accent" />
          </div>
          <div>
            <label class="block text-sm font-medium text-dt-primary">Teléfono</label>
            <input name="telefono" class="mt-1 w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-dt-accent" />
          </div>
          <div>
            <label class="block text-sm font-medium text-dt-primary">Vacante / Área</label>
            <input name="vacante" class="mt-1 w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-dt-accent" />
          </div>
        </div>
      </section>

      <!-- 2. Sección Likert uniforme (1-5) -->
      <section id="section-2" class="test-section">
        <h2 class="text-xl font-semibold mb-6 text-dt-primary border-b border-dt-secondary pb-2">2/4. Afirmaciones (Likert 1–5)</h2>
        <div class="mb-4 bg-yellow-50 p-3 rounded-lg border-l-4 border-yellow-400 text-sm text-gray-700">
          Responde de <b>1</b> (Totalmente en desacuerdo) a <b>5</b> (Totalmente de acuerdo). Mantuvimos la <b>misma escala</b> para todas las afirmaciones para facilitar el análisis estadístico.
        </div>
        <div id="likert-container" class="space-y-6"></div>
      </section>

      <!-- 3. SJT (Elección Múltiple) -->
      <section id="section-3" class="test-section">
        <h2 class="text-xl font-semibold mb-6 text-dt-primary border-b border-dt-secondary pb-2">3/4. Juicio Situacional (SJT)</h2>
        <div class="mb-4 bg-blue-50 p-3 rounded-lg border-l-4 border-dt-accent text-sm text-gray-700">
          Lee cada escenario y elige la opción indicada en las instrucciones del ítem (<b>MEJOR</b> opción o <b>MENOS</b> apropiada). Las alternativas están diseñadas para ser plausibles y evaluar la conducta en contexto laboral.
        </div>
        <div id="sjt-container" class="space-y-6"></div>
      </section>

      <!-- 4. Lógica (opción correcta) + Resultados -->
      <section id="section-4" class="test-section">
        <h2 class="text-xl font-semibold mb-6 text-dt-primary border-b border-dt-secondary pb-2">4/4. Pensamiento Lógico y Resultados</h2>
        <div id="logic-container" class="space-y-6 mb-8"></div>

        <div id="loading-indicator" class="hidden">
          <div class="flex items-center justify-center p-6">
            <svg class="animate-spin h-8 w-8 text-dt-primary mr-3" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-lg text-dt-primary font-medium">Calculando y guardando resultados...</span>
          </div>
          <p class="text-sm text-gray-500 text-center">Esto puede tomar unos segundos.</p>
        </div>

        <div id="results-container" class="mt-4 p-6 bg-dt-primary text-white rounded-lg hidden">
          <h3 class="text-2xl font-bold mb-4">¡Gracias por completar la Evaluación!</h3>
          <p class="mb-6">Tu perfil ha sido procesado por Disruptive Talent.</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
            <div class="bg-white p-4 rounded-lg text-dt-primary shadow-md">
              <h4 class="font-bold text-xl mb-1">Top Competencias</h4>
              <ol id="top-competencias" class="list-decimal list-inside text-dt-primary font-semibold"></ol>
              <p class="text-xs mt-2 text-gray-500">Basado en tus respuestas.</p>
            </div>
            <div class="bg-white p-4 rounded-lg text-dt-primary shadow-md">
              <h4 class="font-bold text-xl mb-1">Puntaje Total</h4>
              <p id="puntaje-total" class="text-2xl font-extrabold text-dt-accent"></p>
              <p class="text-sm mt-2">Suma ponderada por categorías.</p>
            </div>
          </div>

          <div class="mt-6 bg-white text-dt-primary p-4 rounded-lg shadow">
            <h5 class="font-bold">Mensaje</h5>
            <p id="mensaje-final" class="text-sm mt-1">Agradecemos tu tiempo. En breve recibirás un reporte más detallado.</p>
          </div>
        </div>

        <div id="error-message" class="mt-4 p-4 bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg hidden text-left">
          Hubo un error al intentar guardar los datos. Por favor, revisa la configuración del Apps Script.
        </div>
      </section>

      <div id="navigation-controls" class="flex justify-between mt-8 pt-6 border-t border-dt-secondary">
        <button type="button" id="prev-btn" class="nav-btn bg-gray-200 text-gray-700 py-2 px-6 rounded-lg font-semibold hover:bg-gray-300 hidden">Anterior</button>
        <button type="button" id="next-btn" class="nav-btn bg-dt-accent text-white py-2 px-6 rounded-lg font-semibold hover:bg-blue-700 ml-auto">Siguiente</button>
        <button type="button" id="submit-btn" class="nav-btn bg-dt-primary text-white py-2 px-6 rounded-lg font-semibold hover:bg-green-700 hidden ml-auto">Finalizar Test</button>
      </div>
    </form>
  </main>

  <script>
    // ======= CONFIG =======
    // Reemplaza con tu URL de Apps Script desplegado como Web App (permiso: "Cualquiera con el enlace")
    const SCRIPT_URL = "PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE";

    // ======= Banco de ítems (según documento de preguntas e instrucciones) =======
    // Escala uniforme Likert 1..5
    const LIKERT_ITEMS = [
      { categoria: 'Orientación a Resultados', id: 'or', texto: 'Cuando un proyecto se retrasa, me enfoco inmediatamente en identificar acciones correctivas para cumplir el objetivo, incluso si requiere un esfuerzo adicional.' },
      { categoria: 'Atención al Detalle', id: 'ad', texto: 'Revisar meticulosamente mi trabajo en busca de errores menores es una parte esencial y gratificante de mi proceso.' },
      { categoria: 'Autodesarrollo', id: 'au', texto: 'Busco activamente capacitaciones, manuales o expertos para aprender una nueva tecnología esencial para mi rol, incluso si no tengo tiempo dedicado por la empresa.' },
      { categoria: 'Colaboración', id: 'co', texto: 'En un conflicto de equipo, mi principal prioridad es preservar la armonía y encontrar un punto medio que satisfaga a todos.' },
      { categoria: 'Liderazgo Informal', id: 'li', texto: 'En reuniones donde el líder está ausente o pasivo, tomo la iniciativa para establecer la agenda, motivar la participación y asegurar la toma de decisiones.' },
    ];

    // SJT (best/least) con clave correcta
    // mode: 'BEST' => seleccionar la mejor; 'LEAST' => seleccionar la menos efectiva
    const SJT_ITEMS = [
      {
        categoria: 'Flexibilidad y Adaptación', id: 'fa', mode: 'BEST',
        stem: 'Escenario: Un requisito clave en tu proyecto se anula a mitad del sprint. Los cambios impactan un 50% de tu trabajo. ¿Qué acción tomarías primero?',
        opciones: {
          a: 'Detienes el trabajo para analizar el impacto y proponer un plan de ajuste.',
          b: 'Continúas con las tareas restantes que no se vieron afectadas.',
          c: 'Expresas frustración al equipo y pides al gestor que resuelva el cambio.'
        },
        correct: 'a'
      },
      {
        categoria: 'Gestión del Estrés', id: 'ge', mode: 'LEAST',
        stem: 'Escenario: Descubres un error crítico en el código horas antes del lanzamiento. ¿Cuál de las siguientes acciones es la MENOS efectiva para la situación?',
        opciones: {
          a: 'Mantener la calma y evaluar la causa y el impacto exacto del error.',
          b: 'Comunicar la situación de pánico a todo el equipo y a los stakeholders.',
          c: 'Priorizar una solución rápida sobre una corrección perfecta.'
        },
        correct: 'b'
      },
      {
        categoria: 'Innovación', id: 'in', mode: 'BEST',
        stem: 'Escenario: Tu equipo utiliza un proceso tedioso que consume 5 horas semanales. Tienes una idea para automatizarlo. ¿Qué harías primero?',
        opciones: {
          a: 'Inviertes tiempo personal en un prototipo funcional antes de proponerlo.',
          b: 'Presentas la idea de inmediato, pidiendo recursos y tiempo del proyecto actual.',
          c: 'Esperas a que el gestor te pida buscar una solución de mejora.'
        },
        correct: 'a'
      },
      {
        categoria: 'Comunicación Efectiva', id: 'ce', mode: 'BEST',
        stem: 'Escenario: Debes explicar el funcionamiento interno de un sistema complejo a un cliente no técnico en 10 minutos. ¿Cuál sería tu enfoque principal?',
        opciones: {
          a: 'Usar analogías sencillas y enfocar la explicación en los beneficios para el cliente.',
          b: 'Usar el vocabulario técnico preciso para garantizar la exactitud.',
          c: 'Entregar un documento técnico detallado como referencia.'
        },
        correct: 'a'
      },
    ];

    // Lógica: opción múltiple con respuesta correcta
    const LOGIC_ITEMS = [
      {
        categoria: 'Pensamiento Crítico', id: 'pc',
        stem: 'Selecciona el número que continúa la siguiente secuencia lógica: 3, 5, 9, 15, 23, ___ (Patrón: +2, +4, +6, +8, +10)',
        opciones: ['31','32','33','34'],
        correct: '33'
      }
    ];

    // ======= Render UI =======
    const likertContainer = document.getElementById('likert-container');
    const sjtContainer = document.getElementById('sjt-container');
    const logicContainer = document.getElementById('logic-container');

    const renderLikert = () => {
      LIKERT_ITEMS.forEach((q, idx) => {
        const el = document.createElement('div');
        el.className = 'p-4 border border-dt-secondary rounded-lg shadow-sm';
        el.innerHTML = `
          <p class="font-medium mb-2 text-dt-primary">${idx+1}. ${q.texto}</p>
          <p class="text-xs text-gray-500 mb-3">Categoría: ${q.categoria}</p>
          <div class="flex items-center justify-between text-sm">
            <span>1</span>
            <div class="flex gap-4">
              ${[1,2,3,4,5].map(v => `
                <label class="cursor-pointer"><input type="radio" name="likert_${q.id}" value="${v}" required class="h-4 w-4"> ${v}</label>
              `).join('')}
            </div>
            <span>5</span>
          </div>
        `;
        likertContainer.appendChild(el);
      });
    };

    const renderSJT = () => {
      SJT_ITEMS.forEach((q, idx) => {
        const el = document.createElement('div');
        el.className = 'p-4 border border-dt-secondary rounded-lg shadow-sm';
        const opts = Object.entries(q.opciones).map(([key, txt]) => `
          <label class="block mb-2 cursor-pointer">
            <input type="radio" name="sjt_${q.id}" value="${key}" required class="mr-2"> (${key}) ${txt}
          </label>
        `).join('');
        const modeText = q.mode === 'BEST' ? 'Elige la MEJOR opción.' : 'Elige la MENOS efectiva.';
        el.innerHTML = `
          <p class="font-medium mb-2 text-dt-primary">${idx+1}. ${q.stem}</p>
          <p class="text-xs text-gray-500 mb-3">Categoría: ${q.categoria} · ${modeText}</p>
          <div>${opts}</div>
        `;
        sjtContainer.appendChild(el);
      });
    };

    const renderLogic = () => {
      LOGIC_ITEMS.forEach((q, idx) => {
        const el = document.createElement('div');
        el.className = 'p-4 border border-dt-secondary rounded-lg shadow-sm';
        const opts = q.opciones.map((opt,i)=>`
          <label class="block mb-2 cursor-pointer">
            <input type="radio" name="logic_${q.id}" value="${opt}" required class="mr-2"> ${opt}
          </label>
        `).join('');
        el.innerHTML = `
          <p class="font-medium mb-2 text-dt-primary">${idx+1}. ${q.stem}</p>
          <p class="text-xs text-gray-500 mb-3">Categoría: ${q.categoria}</p>
          <div>${opts}</div>
        `;
        logicContainer.appendChild(el);
      });
    };

    renderLikert();
    renderSJT();
    renderLogic();

    // ======= Navegación =======
    const sections = [...document.querySelectorAll('.test-section')];
    let current = 0;
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');

    function showSection(i) {
      sections.forEach((s, idx) => s.classList.toggle('active', idx === i));
      prevBtn.classList.toggle('hidden', i === 0);
      nextBtn.classList.toggle('hidden', i >= sections.length - 1);
      submitBtn.classList.toggle('hidden', i < sections.length - 1);
    }

    prevBtn.addEventListener('click', () => { if (current > 0) { current--; showSection(current); } });
    nextBtn.addEventListener('click', () => { if (validateSection(current)) { current++; showSection(current); } });
    submitBtn.addEventListener('click', onSubmit);

    function validateSection(i) {
      const sec = sections[i];
      const required = sec.querySelectorAll('input[required], select[required], textarea[required]');
      for (const input of required) {
        const name = input.name;
        if (input.type === 'radio') {
          const group = sec.querySelectorAll(`input[name="${name}"]`);
          const checked = [...group].some(r => r.checked);
          if (!checked) { alert('Por favor, completa las preguntas requeridas.'); return false; }
        } else if (!input.value) {
          alert('Por favor, completa las preguntas requeridas.');
          return false;
        }
      }
      return true;
    }

    // ======= Scoring =======
    // Likert: 1..5 directo a categoría
    // SJT BEST/LEAST: +5 si acierta la clave, +0 si no
    // Lógica: +5 si acierta
    function computeScores(formData) {
      const categorias = new Set([
        ...LIKERT_ITEMS.map(i=>i.categoria),
        ...SJT_ITEMS.map(i=>i.categoria),
        ...LOGIC_ITEMS.map(i=>i.categoria),
      ]);
      const scores = {}; categorias.forEach(c => scores[c] = 0);

      LIKERT_ITEMS.forEach(q => {
        const v = Number(formData.get(`likert_${q.id}`) || 0);
        scores[q.categoria] += v;
      });

      SJT_ITEMS.forEach(q => {
        const v = formData.get(`sjt_${q.id}`);
        if (v && v === q.correct) scores[q.categoria] += 5;
      });

      LOGIC_ITEMS.forEach(q => {
        const v = formData.get(`logic_${q.id}`);
        if (v && v === q.correct) scores[q.categoria] += 5;
      });

      const total = Object.values(scores).reduce((a,b)=>a+b,0);
      return { scores, total };
    }

    function topCompetencias(scores, k=3) {
      return Object.entries(scores)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,k);
    }

    // ======= Submit & Sheets =======
    async function onSubmit() {
      if (!validateSection(current)) return;
      const form = document.getElementById('psychometric-test-form');
      const formData = new FormData(form);
      const { scores, total } = computeScores(formData);

      // UI feedback
      document.getElementById('loading-indicator').classList.remove('hidden');
      document.getElementById('results-container').classList.add('hidden');
      document.getElementById('error-message').classList.add('hidden');

      const payload = {
        timestamp: new Date().toISOString(),
        nombre: formData.get('nombre') || '',
        correo: formData.get('correo') || '',
        telefono: formData.get('telefono') || '',
        vacante: formData.get('vacante') || '',
        total,
        scores,
        respuestas: Object.fromEntries([...formData.entries()]),
      };

      // Mostrar resultados locales (aunque falle el envío)
      renderResults(scores, total);

      try {
        if (!SCRIPT_URL || SCRIPT_URL.includes('PASTE_YOUR')) throw new Error('Falta configurar SCRIPT_URL');
        const body = new URLSearchParams();
        body.append('payload', JSON.stringify(payload));

        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body // Evita preflight CORS; no agregues headers manuales
        });

        let ok = false;
        try {
          const data = await res.json();
          ok = !!data.ok;
        } catch (_) { /* puede no venir JSON válido; ignorar */ }

        if (!res.ok || !ok) throw new Error('Respuesta no OK');
        document.getElementById('loading-indicator').classList.add('hidden');
        document.getElementById('results-container').classList.remove('hidden');
        current = sections.length - 1; showSection(current);
      } catch (e) {
        document.getElementById('loading-indicator').classList.add('hidden');
        document.getElementById('error-message').classList.remove('hidden');
        current = sections.length - 1; showSection(current);
        console.error(e);
      }
    }

    function renderResults(scores, total) {
      const list = document.getElementById('top-competencias');
      list.innerHTML = '';
      topCompetencias(scores).forEach(([cat, val]) => {
        const li = document.createElement('li');
        li.textContent = `${cat}: ${val}`;
        list.appendChild(li);
      });
      document.getElementById('puntaje-total').textContent = total;
      document.getElementById('results-container').classList.remove('hidden');
    }

    // init
    showSection(current);
  </script>
</body>
</html>
